# empieza codigo
import streamlit as st
from openpyxl import Workbook
from io import BytesIO
from datetime import datetime
import numpy as np

def mostrar_app():
    st.set_page_config(page_title="Generador CTG - Transformador de Tensi√≥n", layout="centered")

    st.title("üìÑ Generador de Ficha CTG")
    st.subheader("Transformador de Tensi√≥n")

    # 1. DATOS PARA ANOTACI√ìN MANUAL
    st.markdown("### üñäÔ∏è Datos para anotaci√≥n manual")
    responsable = st.text_input("Nombre del responsable")
    fecha_elaboracion = st.date_input("Fecha de elaboraci√≥n")
    area_tecnica = st.text_input("√Årea t√©cnica")
    proyecto = st.text_input("Proyecto o ubicaci√≥n general")

    # 2. PAR√ÅMETROS EL√âCTRICOS
    st.markdown("### ‚ö° Par√°metros el√©ctricos")
    tension_primaria = st.text_input("Tensi√≥n primaria (kV)")
    tension_secundaria = st.text_input("Tensi√≥n secundaria (V)")
    tension_aislamiento = st.text_input("Tensi√≥n de aislamiento (kV)")
    tension_impulso = st.text_input("Tensi√≥n de impulso (kV)")

    frecuencia = "60 Hz"
    st.markdown("**Frecuencia asignada (fr):** 60 Hz  \n*Valor fijo para sistemas el√©ctricos en Colombia*")

    # Factor de tensi√≥n asignado con dos subpar√°metros
    st.markdown("### üìä Factor de tensi√≥n asignado")
    col1, col2 = st.columns(2)
    with col1:
        factor_permanente = st.selectbox(
            "A. Permanente",
            options=[f"{v:.1f}" for v in np.arange(1.0, 2.1, 0.1)]
        )
    with col2:
        factor_30s = st.selectbox(
            "B. Durante 30 segundos",
            options=[f"{v:.1f}" for v in np.arange(1.0, 2.1, 0.1)]
        )

    # Tipo de conexi√≥n
    tipo_conexion = st.selectbox(
        "Tipo de conexi√≥n",
        options=["Estrella (Y)", "Delta (Œî)", "Estrella aterrizada (Yg)", "Delta abierta", "Monof√°sico"]
    )

    # Tipo de aislamiento
    tipo_aislamiento = st.selectbox(
        "Tipo de aislamiento",
        options=["Aceite mineral", "Aceite vegetal", "SF6", "Aire", "Resina ep√≥xica"]
    )

    # 3. PAR√ÅMETROS ADICIONALES
    st.markdown("### üß™ Par√°metros adicionales del transformador de tensi√≥n")
    capacidad_total = st.text_input("Capacidad total (pF)")
    c1 = st.text_input("Condensador de alta tensi√≥n (C1) (pF)")
    c2 = st.text_input("Condensador de tensi√≥n intermedia (C2) (pF)")
    tension_intermedia = st.text_input("Tensi√≥n intermedia asignada en circuito abierto (kV)")
    num_devanados = st.text_input("N√∫mero de devanados secundarios")

    # BOT√ìN PARA GENERAR FICHA
    if st.button("Generar ficha CTG"):
        ficha_ctg = {
            # Datos manuales
            "Responsable": responsable,
            "Fecha de elaboraci√≥n": fecha_elaboracion.strftime("%Y-%m-%d"),
            "√Årea t√©cnica": area_tecnica,
            "Proyecto": proyecto,

            # Datos fijos
            "Tipo de equipo": "Transformador de Tensi√≥n",
            "Frecuencia asignada (fr)": frecuencia,
            "Estado": "Operativo",
            "Fecha de registro": datetime.now().strftime("%Y-%m-%d"),

            # Par√°metros el√©ctricos
            "Tensi√≥n primaria (kV)": tension_primaria,
            "Tensi√≥n secundaria (V)": tension_secundaria,
            "Tensi√≥n de aislamiento (kV)": tension_aislamiento,
            "Tensi√≥n de impulso (kV)": tension_impulso,
            "Factor de tensi√≥n asignado - Permanente": factor_permanente,
            "Factor de tensi√≥n asignado - Durante 30s": factor_30s,
            "Tipo de conexi√≥n": tipo_conexion,
            "Tipo de aislamiento": tipo_aislamiento,

            # Par√°metros adicionales
            "Capacidad total (pF)": capacidad_total,
            "Condensador de alta tensi√≥n (C1) (pF)": c1,
            "Condensador de tensi√≥n intermedia (C2) (pF)": c2,
            "Tensi√≥n intermedia asignada en circuito abierto (kV)": tension_intermedia,
            "N√∫mero de devanados secundarios": num_devanados
        }

        # Crear Excel en memoria
        wb = Workbook()
        ws = wb.active
        ws.title = "Ficha CTG"
        ws.append(["Par√°metro", "Valor"])
        for parametro, valor in ficha_ctg.items():
            ws.append([parametro, valor])

        output = BytesIO()
        wb.save(output)
        output.seek(0)

        st.success("‚úÖ Ficha CTG generada correctamente.")
        st.download_button(
            label="üì• Descargar Excel",
            data=output,
            file_name="CTG_TransformadorTension.xlsx",
            mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
        )
